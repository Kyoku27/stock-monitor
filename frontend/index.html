<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>在庫モニター</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f8f8f8;
    }
    h1 {
      font-size: 24px;
    }
    input, select {
      padding: 5px;
      margin: 5px 10px 5px 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f4f4f4;
    }
  </style>
</head>
<body>
  <h1>在庫モニター（楽天 + Google Sheets）</h1>

  <label>SKU検索：</label>
  <input type="text" id="skuSearch" placeholder="例: MS006-1-BU" />

  <label>ブランド：</label>
  <select id="brandFilter"></select>

  <button onclick="loadStock()">検索</button>

  <table>
    <thead>
      <tr>
        <th>ブランド</th>
        <th>SKU</th>
        <th>楽天在庫</th>
        <th>Google在庫</th>
      </tr>
    </thead>
    <tbody id="stock-table">
      <tr><td colspan="4">読み込み中...</td></tr>
    </tbody>
  </table>

  <script>
    let allMappingData = [];

    async function fetchMappingData() {
      const res = await fetch("/api/stock/mapping");
      const data = await res.json();
      allMappingData = data;
      populateBrandFilter(data);
      loadStock();  // 初回加载
    }

    function populateBrandFilter(data) {
      const select = document.getElementById("brandFilter");
      const brands = Array.from(new Set(data.map(row => row["ブランド"]).filter(Boolean))).sort();
      select.innerHTML = '<option value="">すべて</option>';
      brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        select.appendChild(option);
      });
    }

    async function loadStock() {
      const skuKeyword = document.getElementById("skuSearch").value.trim().toLowerCase();
      const selectedBrand = document.getElementById("brandFilter").value;

      const filtered = allMappingData.filter(row => {
        const sku = (row["システム連携用SKU番号"] || "").toLowerCase();
        const brand = row["ブランド"] || "";
        return (!skuKeyword || sku.includes(skuKeyword)) &&
               (!selectedBrand || brand === selectedBrand);
      });

      const skuList = filtered.map(row => row["システム連携用SKU番号"]).filter(Boolean);
      if (skuList.length === 0) {
        renderTable([]);
        return;
      }

      const manageNumber = "smartpetfeeder"; // 固定参数，确保你的后端支持
      const query = skuList.map(sku => `sku=${encodeURIComponent(sku)}`).join("&");

      let stockData = [];
      try {
        const res = await fetch(`/api/stock/rakuten?manage=${manageNumber}&${query}`);
        stockData = await res.json();
      } catch (e) {
        console.error("楽天API呼び出し失敗", e);
      }

      const merged = stockData.map(row => {
        const match = allMappingData.find(item => item["システム連携用SKU番号"] === row.sku);
        return {
          brand: match?.["ブランド"] || "-",
          sku: row.sku,
          rakuten: row.rakuten ?? "-",
          google: row.google ?? "-"
        };
      });

      renderTable(merged);
    }

    function renderTable(data) {
      const tbody = document.getElementById("stock-table");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4'>一致するデータがありません</td></tr>";
        return;
      }

      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.brand}</td>
          <td>${row.sku}</td>
          <td>${row.rakuten}</td>
          <td>${row.google}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    fetchMappingData(); // 页面初始化时加载
  </script>
</body>
</html>
