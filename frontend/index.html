<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>在庫モニター（楽天 + Google Sheets）</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 40px;
      background: #f4f7fa;
      color: #333;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 20px;
    }
    .controls {
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 8px;
      font-size: 14px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #f0f2f5;
    }
  </style>
</head>
<body>
  <h1>在庫モニター（楽天 + Google Sheets）</h1>
  <div class="controls">
    <label>SKU検索：</label>
    <input type="text" id="skuSearch" placeholder="例: PD50" />

    <label>ブランド：</label>
    <select id="brandFilter"></select>

    <button onclick="loadStock()">検索</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ブランド</th>
        <th>SKU</th>
        <th>楽天在庫</th>
        <th>Google自社</th>
        <th>Google City</th>
      </tr>
    </thead>
    <tbody id="stock-table">
      <tr><td colspan="5">読み込み中...</td></tr>
    </tbody>
  </table>

  <script>
    let allMappingData = [];

    async function fetchMappingData() {
      const res = await fetch("/api/stock/mapping");
      const data = await res.json();
      allMappingData = data;
      populateBrandFilter(data);
      loadStock();
    }

    function populateBrandFilter(data) {
      const select = document.getElementById("brandFilter");
      const brands = Array.from(new Set(data.map(row => row["ブランド"]).filter(Boolean))).sort();
      select.innerHTML = '<option value="">すべて</option>';
      brands.forEach(brand => {
        const option = document.createElement("option");
        option.value = brand;
        option.textContent = brand;
        select.appendChild(option);
      });
    }

    async function loadStock() {
      const skuKeyword = document.getElementById("skuSearch").value.trim().toLowerCase();
      const selectedBrand = document.getElementById("brandFilter").value;
      const tbody = document.getElementById("stock-table");
      tbody.innerHTML = "";

      const filtered = allMappingData.filter(row => {
        const sku = (row["システム連携用SKU番号"] || "").toLowerCase();
        const brand = row["ブランド"] || "";
        return (!skuKeyword || sku.includes(skuKeyword)) &&
               (!selectedBrand || brand === selectedBrand);
      });

      if (filtered.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5'>一致するデータがありません</td></tr>";
        return;
      }

      for (const row of filtered) {
        const sku = row["システム連携用SKU番号"];
        const manage = row["SKU管理番号"];
        let rakuten = "-", googleA = "-", googleB = "-";

        try {
          if (manage && sku) {
            const res1 = await fetch(`/api/stock/rakuten?manage=${encodeURIComponent(manage)}&sku=${encodeURIComponent(sku)}`);
            const json1 = await res1.json();
            const match = json1.find(item => item.variantId === sku);
            rakuten = match ? match.quantity : "-";
          }

          const res2 = await fetch(`/api/stock/gsheet?sku=${encodeURIComponent(sku)}`);
          const json2 = await res2.json();
          if (json2.在庫) {
            googleA = json2.在庫.自社 ?? json2.在庫.在庫 ?? "-";
            googleB = json2.在庫.City ?? "-";
          }
        } catch (e) {
          console.error("API取得失敗", e);
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row["ブランド"]}</td>
          <td>${sku}</td>
          <td>${rakuten}</td>
          <td>${googleA}</td>
          <td>${googleB}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    fetchMappingData();
  </script>
</body>
</html>

